<!-- pages/storageHome/storageHome.wxml -->
<view class="container">
  <!-- é¡¶éƒ¨æ“ä½œæŒ‰é’® -->
  <view class="header-btns">
    <view class="top-btn goods-manage" bindtap="goToGoodsManage">
      <text class="btn-icon">ğŸ“¦</text>
      <text class="btn-text">å•†å“ç®¡ç†</text>
    </view>
    <view class="top-btn add-storage" bindtap="showAddModal">
      <text class="btn-icon">â•</text>
      <text class="btn-text">æ–°å¢å¯„å­˜</text>
    </view>
  </view>

  <!-- æŸ¥è¯¢åŒºåŸŸ -->
  <view class="query-section">
    <view class="query-title">å¯„å­˜æŸ¥è¯¢</view>
    <view class="query-input-wrap">
      <input 
        class="query-input" 
        type="number"
        placeholder="è¯·è¾“å…¥ç”¨æˆ·æ‰‹æœºå·" 
        value="{{queryPhone}}"
        maxlength="11"
        bindinput="onQueryPhoneInput"
      />
      <view class="query-btns">
        <button class="btn-query" bindtap="queryStorage">æŸ¥è¯¢</button>
        <button class="btn-reset" bindtap="resetQuery">é‡ç½®</button>
      </view>
    </view>
  </view>

  <!-- æŸ¥è¯¢ç»“æœåŒºåŸŸ -->
  <scroll-view class="result-section" scroll-y="{{true}}" wx:if="{{storageList.length > 0}}">
    <view class="result-header">
      <text class="result-title">ç”¨æˆ·å¯„å­˜å•†å“</text>
      <text class="result-count">å…± {{storageList.length}} æ¡</text>
    </view>
    
    <view class="storage-list">
      <view class="storage-card" wx:for="{{storageList}}" wx:key="id">
        <view class="card-row-first">
          <view class="goods-info-left">
            <text class="goods-name">{{item.goodsName}}</text>
            <text class="goods-unit">{{item.units}}</text>
          </view>
          <text class="stock-remain">å‰©ä½™ {{item.stockNum}}{{item.units}}</text>
        </view>
        
        <view class="card-row-second">
          <text class="expire-time">åˆ°æœŸ: {{item.expireTime}}</text>
          <view class="card-actions">
            <view class="stepper-wrap">
              <text class="stepper-btn {{item.takeNum <= 0 ? 'disabled' : ''}}" bindtap="changeTakeNum" data-index="{{index}}" data-delta="-1">-</text>
              <input 
                class="stepper-input" 
                type="number" 
                value="{{item.takeNum}}"
                data-index="{{index}}"
                bindblur="onTakeNumInput"
              />
              <text class="stepper-btn {{item.takeNum >= item.stockNum ? 'disabled' : ''}}" bindtap="changeTakeNum" data-index="{{index}}" data-delta="1">+</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <view class="confirm-bar" wx:if="{{hasSelected}}">
      <view class="selected-info">
        <text>å·²é€‰ {{selectedCount}} ç§å•†å“</text>
        <text class="total-num">å…± {{selectedTotal}} ä»¶</text>
      </view>
      <button class="btn-confirm-take" bindtap="confirmTakeOut">ç¡®è®¤å–å‡º</button>
    </view>
  </scroll-view>

  <view class="empty-state" wx:if="{{queryPhone && storageList.length === 0 && !loading}}">
    <text class="empty-icon">ğŸ”</text>
    <text class="empty-text">æœªæ‰¾åˆ°è¯¥ç”¨æˆ·çš„å¯„å­˜è®°å½•</text>
  </view>

  <!-- æ–°å¢å¯„å­˜å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showAddModal}}" catchtap="preventBubble">
    <view class="modal-content" catchtap="preventBubble">
      <view class="modal-header">
        <text class="modal-title">æ–°å¢å¯„å­˜</text>
        <text class="modal-close" catchtap="hideAddModal">Ã—</text>
      </view>
      
      <scroll-view class="modal-body" scroll-y="{{true}}">
        <view class="form-item-inline">
          <view class="form-row">
            <text class="form-label-inline required">ç”¨æˆ·æ‰‹æœºå·</text>
            <input 
              class="form-input-inline" 
              type="number"
              placeholder="è¯·è¾“å…¥æ‰‹æœºå·" 
              value="{{addForm.phone}}"
              maxlength="11"
              data-field="phone"
              bindinput="onAddFormInput"
            />
          </view>
        </view>

        <view class="form-item-inline">
          <view class="form-row">
            <text class="form-label-inline required">åˆ°æœŸæ—¶é—´</text>
            <picker mode="multiSelector" range="{{dateTimeArray}}" value="{{dateTimeIndex}}" bindchange="onExpireDateTimeChange" bindcolumnchange="onDateTimeColumnChange">
              <view class="picker-value-inline">
                {{addForm.expireDateTime}} 
                <text class="picker-arrow">(é»˜è®¤30å¤©)</text>
              </view>
            </picker>
          </view>
        </view>

        <view class="form-item goods-list-item">
          <view class="goods-list-header">
            <text class="form-label required">å¯„å­˜å•†å“</text>
            <view class="add-goods-btn" catchtap="addGoodsItem">
              <text class="add-icon">+</text>
              <text>æ·»åŠ å•†å“</text>
            </view>
          </view>
          
          <view class="add-goods-list">
            <view class="add-goods-item" wx:for="{{addForm.goodsList}}" wx:key="index">
              <view class="goods-select-row">
                <view class="goods-select-box" catchtap="openGoodsSelector" data-index="{{index}}">
                  <view class="goods-select-display {{item.goodsId ? '' : 'placeholder'}}">
                    <text class="select-text">{{item.goodsName || 'ç‚¹å‡»é€‰æ‹©å•†å“'}}</text>
                  </view>
                </view>
                
                <view class="stepper-wrap large">
                  <text class="stepper-btn {{item.num <= 1 ? 'disabled' : ''}}" catchtap="changeGoodsNum" data-index="{{index}}" data-delta="-1">-</text>
                  <input 
                    class="stepper-input" 
                    type="number" 
                    value="{{item.num}}"
                    data-index="{{index}}"
                    bindblur="onGoodsNumInput"
                  />
                  <text class="stepper-btn" catchtap="changeGoodsNum" data-index="{{index}}" data-delta="1">+</text>
                </view>
                {{item.unit}}
                <view class="delete-goods {{addForm.goodsList.length <= 1 ? 'disabled' : ''}}" catchtap="deleteGoodsItem" data-index="{{index}}">
                  <text>ğŸ—‘</text>
                </view>
              </view>
              <!-- <view class="goods-unit-hint" wx:if="{{item.unit}}">å•ä½: {{item.unit}}</view> -->
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <button class="btn-cancel" catchtap="hideAddModal">å–æ¶ˆ</button>
        <button class="btn-confirm {{!isAddFormValid ? 'disabled' : ''}}" catchtap="submitAddStorage">ç¡®è®¤å¯„å­˜</button>
      </view>
    </view>
  </view>

  <!-- å•†å“é€‰æ‹©å¼¹çª—ï¼ˆç¬¬äºŒå±‚ï¼‰ -->
  <view class="goods-selector-mask" wx:if="{{showGoodsSelector}}" catchtap="preventBubble">
    <view class="goods-selector-content" catchtap="preventBubble">
      <view class="selector-header">
        <text class="selector-title">é€‰æ‹©å•†å“</text>
        <text class="selector-close" catchtap="closeGoodsSelector">Ã—</text>
      </view>
      
      <scroll-view class="selector-body" scroll-y="{{true}}">
        <view 
          class="goods-option {{item.id === null ? 'placeholder' : ''}} {{tempSelectedGoodsId === item.id ? 'selected' : ''}}" 
          wx:for="{{goodsTypeList}}" 
          wx:key="id"
          data-goods="{{item}}"
          catchtap="onGoodsOptionTap"
        >
          <view class="option-info">
            <text class="option-name">{{item.goodsName}}</text>
            <text class="option-unit" wx:if="{{item.units}}">{{item.units}}</text>
          </view>
          <text class="option-check" wx:if="{{tempSelectedGoodsId === item.id}}">âœ“</text>
        </view>
      </scroll-view>
      
      <view class="selector-footer">
        <button class="btn-confirm-select {{!tempSelectedGoodsId ? 'disabled' : ''}}" catchtap="confirmGoodsSelect">ç¡®è®¤é€‰æ‹©</button>
      </view>
    </view>
  </view>
</view>